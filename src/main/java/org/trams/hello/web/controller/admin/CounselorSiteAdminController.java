/*
 * Created on 12 Apr 2017 ( Time 10:26:03 )
 * Generated by Telosys Tools Generator ( version 2.1.1 )
 */
package org.trams.hello.web.controller.admin;

import java.util.Date;
import java.util.List;

import javax.annotation.Resource;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.trams.hello.bean.BannerForm;
import org.trams.hello.bean.ImageBanner;
import org.trams.hello.bean.ImageWebsite;
import org.trams.hello.business.service.ImageWebsiteService;
import org.trams.hello.web.common.AbstractController;
import org.trams.hello.web.common.utils.FileUtils;

@Controller
@RequestMapping("/admin/content/counselorSite")
public class CounselorSiteAdminController extends AbstractController {

	private static final String MAIN_ENTITY_NAME = "counselorSite";
	private static String nav = "counselorSite";
	private static final String JSP_BANNER   = "admin/content/counselorSite/banner";
	@Resource
    private ImageWebsiteService imageWebsiteService;
	@Resource
	ServletContext servletContext;
	public CounselorSiteAdminController() {
		super(CounselorSiteAdminController.class, MAIN_ENTITY_NAME );
		log("CounselorSiteAdminController created.");
	}

	@RequestMapping(value = "/banner", method = RequestMethod.GET)
	public String list(
			HttpSession session,
			HttpServletRequest request,
			Model model) {
		List<ImageWebsite> list = imageWebsiteService.listByTypeAndOrderNumber((short) 1);
		
		model.addAttribute("list", list);
		model.addAttribute("size", list.size());
		model.addAttribute("activePage", nav);
		return JSP_BANNER;
	}
	
	@RequestMapping(value = "/banner", method = RequestMethod.POST)
	public String list_POST(
			HttpSession session,
			HttpServletRequest request,
			@ModelAttribute BannerForm b,
			Model model) {
		//delete all imgae banner
		try {
			imageWebsiteService.deleteByType((short)1);
			System.out.println("size: "+b.getList().size());
			for (ImageBanner i : b.getList()) {
				if(i.getImageUrl() != null || !i.getFile().isEmpty()){
					System.out.println("file: "+ i.getId());
					ImageWebsite img = new ImageWebsite();
					img.setCreateDate(new Date());
					if (!i.getFile().isEmpty()) {
						try {
							img.setImageUrl(FileUtils.saveFileOrigin(i.getFile(), servletContext));
						} catch (Exception e) {
							img.setImageUrl(" ");
						}
						 
						 img.setImageName(i.getFile().getName());
					}else{
						 img.setImageUrl(i.getImageUrl());
						 img.setImageName(i.getImageName());
					}
					img.setId((i.getOrderNumber()).intValue());
					img.setOrderNumber(i.getOrderNumber());
					img.setType((short)1);
					img.setUpdateDate(new Date());
					imageWebsiteService.create(img);
				}
				
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		return "redirect:/"+JSP_BANNER;
	}
}
